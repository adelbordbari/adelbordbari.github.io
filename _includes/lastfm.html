<section>
  <script src="https://recentfm.rknight.me/now.js?u=thenitwit&nomoji=true"></script>
  <!-- <script src="https://recentfm.rknight.me/now.js?u=thenitwit&e=▶️"></script> -->
</section>

<script>
  (function() {
    function placeGif(root) {
      const gif = document.querySelector('.recent-gif');
      if (!gif || root.contains(gif)) return; // nothing to do / already moved

      // style tweak for inline layout
      gif.classList.add('recent-gif--inline');

      const art = root.querySelector('.recent-played-art');
      const track = root.querySelector('.recent-played-track');

      if (art) {
        art.after(gif);                // put GIF right after the cover art
      } else if (track) {
        root.insertBefore(gif, track); // fallback: before the text
      } else {
        root.appendChild(gif);         // last resort: at the end
      }
    }

    function tryEnhance(root) {
      if (!root) return;

      // Move GIF as soon as we see the widget (even before art loads)
      placeGif(root);

      // If we already added art earlier, stop here
      if (root.querySelector('.recent-played-art')) return;

      const link = root.querySelector('.recent-played-track a');
      if (!link) return;

      const txt = link.textContent.trim();
      const SEP = ' by ';
      if (!txt.includes(SEP)) return;
      const [title, artist] = txt.split(SEP);
      if (!title || !artist) return;

      const cacheKey = `art:${title}::${artist}`;
      const cached = sessionStorage.getItem(cacheKey);
      if (cached) {
        insert(root, title, artist, cached);
        placeGif(root);
        return;
      }

      const params = new URLSearchParams({
        term: `${title} ${artist}`,
        entity: 'song',
        limit: '1'
      });
      fetch(`https://itunes.apple.com/search?${params.toString()}`)
        .then(r => r.json())
        .then(data => {
          const hit = data && data.results && data.results[0];
          let art = hit && hit.artworkUrl100;
          if (art) art = art.replace(/100x100bb\.jpg/, '300x300bb.jpg');
          if (art) {
            sessionStorage.setItem(cacheKey, art);
            insert(root, title, artist, art);
            placeGif(root); // ensure GIF sits after the art
          } else {
            placeGif(root); // still move the GIF if no art
          }
        })
        .catch(() => {
          placeGif(root);   // fail silently but still move the GIF
        });
    }

    function insert(root, title, artist, src) {
      if (root.querySelector('.recent-played-art')) return;
      const img = document.createElement('img');
      img.className = 'recent-played-art';
      img.alt = `${title} — ${artist} (cover art)`;
      img.loading = 'lazy';
      img.decoding = 'async';
      img.src = src;
      root.prepend(img);
    }

    // 1) If it’s already on the page (fast load), enhance immediately.
    const existing = document.querySelector('.recent-played');
    if (existing) tryEnhance(existing);

    // 2) Otherwise, observe DOM for when the widget arrives.
    const mo = new MutationObserver(muts => {
      for (const m of muts) {
        m.addedNodes && m.addedNodes.forEach(node => {
          if (node.nodeType === 1) {
            if (node.matches && node.matches('.recent-played')) tryEnhance(node);
            const found = node.querySelector && node.querySelector('.recent-played');
            if (found) tryEnhance(found);
          }
        });
      }
    });
    mo.observe(document.documentElement, { childList: true, subtree: true });
  })();
</script>
