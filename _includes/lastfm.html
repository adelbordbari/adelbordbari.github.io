<section>
  <script src="https://recentfm.rknight.me/now.js?u=thenitwit&nomoji=true"></script>
  <!-- <script src="https://recentfm.rknight.me/now.js?u=thenitwit&e=▶️"></script> -->
</section>

<script>
  (function() {
    function placeGif(root) {
      // already placed?
      if (root.querySelector('.recent-gif')) return;

      // create the gif only now (after widget exists)
      const gif = document.createElement('img');
      gif.src = 'assets/red_circle.gif';
      gif.alt = '';
      gif.setAttribute('aria-hidden', 'true');
      gif.className = 'recent-gif recent-gif--inline';

      const art = root.querySelector('.recent-played-art');
      const track = root.querySelector('.recent-played-track');

      if (art) {
        art.after(gif);
      } else if (track) {
        root.insertBefore(gif, track);
      } else {
        root.appendChild(gif);
      }
    }

    function tryEnhance(root) {
      if (!root) return;

      // Move/create GIF first so it's part of the widget render
      placeGif(root);

      // If art already present, we're done
      if (root.querySelector('.recent-played-art')) return;

      const link = root.querySelector('.recent-played-track a');
      if (!link) return;

      const txt = link.textContent.trim();
      const SEP = ' by ';
      if (!txt.includes(SEP)) return;
      const [title, artist] = txt.split(SEP);
      if (!title || !artist) return;

      const cacheKey = `art:${title}::${artist}`;
      const cached = sessionStorage.getItem(cacheKey);
      if (cached) return insert(root, title, artist, cached);

      const params = new URLSearchParams({
        term: `${title} ${artist}`,
        entity: 'song',
        limit: '1'
      });
      fetch(`https://itunes.apple.com/search?${params.toString()}`)
        .then(r => r.json())
        .then(data => {
          const hit = data && data.results && data.results[0];
          let art = hit && hit.artworkUrl100;
          if (art) art = art.replace(/100x100bb\.jpg/, '300x300bb.jpg');
          if (art) {
            sessionStorage.setItem(cacheKey, art);
            insert(root, title, artist, art);
          }
        })
        .catch(() => {/* silent */});
    }

    function insert(root, title, artist, src) {
      if (root.querySelector('.recent-played-art')) return;
      const img = document.createElement('img');
      img.className = 'recent-played-art';
      img.alt = `${title} — ${artist} (cover art)`;
      img.loading = 'lazy';
      img.decoding = 'async';
      img.src = src;
      root.prepend(img);
    }

    // If it’s already on the page (fast load), enhance immediately.
    const existing = document.querySelector('.recent-played');
    if (existing) tryEnhance(existing);

    // Otherwise, observe for widget arrival.
    const mo = new MutationObserver(muts => {
      for (const m of muts) {
        m.addedNodes && m.addedNodes.forEach(node => {
          if (node.nodeType === 1) {
            if (node.matches && node.matches('.recent-played')) tryEnhance(node);
            const found = node.querySelector && node.querySelector('.recent-played');
            if (found) tryEnhance(found);
          }
        });
      }
    });
    mo.observe(document.documentElement, { childList: true, subtree: true });
  })();
</script>
