<section>
  <img src="assets/red_circle.gif" alt="Now playing" class="recent-gif">
  <script src="https://recentfm.rknight.me/now.js?u=thenitwit&noemoji=true"></script>
  <!-- <script src="https://recentfm.rknight.me/now.js?u=thenitwit&e=▶️"></script> -->
</section>

<script>
  (function() {
    let gifInserted = false;

    function insertGifOnce(root) {
      if (gifInserted) return;
      const track = root.querySelector('.recent-played-track');
      if (!track) return;

      const img = document.createElement('img');
      img.className = 'recent-played-gif';
      img.src = '/assets/red_circle.gif'; // use 'assets/red_circle.gif' if your site isn't at domain root
      img.alt = 'Now playing';
      img.loading = 'lazy';
      img.decoding = 'async';

      root.insertBefore(img, track);
      gifInserted = true;
    }

    // 1) If it's already on the page, do it once.
    const existing = document.querySelector('.recent-played');
    if (existing) {
      tryEnhance(existing); // your existing cover-art enhancer
      insertGifOnce(existing); // insert GIF just once
    }

    // 2) Otherwise, observe until we insert once, then disconnect.
    const mo = new MutationObserver(muts => {
      if (gifInserted) {
        mo.disconnect();
        return;
      }
      for (const m of muts) {
        m.addedNodes && m.addedNodes.forEach(node => {
          if (gifInserted || node.nodeType !== 1) return;
          const target =
            (node.matches && node.matches('.recent-played') && node) ||
            (node.querySelector && node.querySelector('.recent-played'));
          if (target) {
            tryEnhance(target);
            insertGifOnce(target);
            mo.disconnect(); // stop observing after first insert
          }
        });
      }
    });
    if (!gifInserted) {
      mo.observe(document.documentElement, {
        childList: true,
        subtree: true
      });
    }

    function tryEnhance(root) {
      if (!root || root.querySelector('.recent-played-art')) return;
      const link = root.querySelector('.recent-played-track a');
      if (!link) return;

      const txt = link.textContent.trim();
      const SEP = ' by ';
      if (!txt.includes(SEP)) return;
      const [title, artist] = txt.split(SEP);
      if (!title || !artist) return;

      const cacheKey = `art:${title}::${artist}`;
      const cached = sessionStorage.getItem(cacheKey);
      if (cached) return insert(root, title, artist, cached);

      const params = new URLSearchParams({
        term: `${title} ${artist}`,
        entity: 'song',
        limit: '1'
      });
      fetch(`https://itunes.apple.com/search?${params.toString()}`)
        .then(r => r.json())
        .then(data => {
          const hit = data && data.results && data.results[0];
          let art = hit && hit.artworkUrl100;
          if (art) art = art.replace(/100x100bb\.jpg/, '300x300bb.jpg');
          if (art) {
            sessionStorage.setItem(cacheKey, art);
            insert(root, title, artist, art);
          }
        })
        .catch(() => {
          /* fail silently */
        });
    }

    function insert(root, title, artist, src) {
      if (root.querySelector('.recent-played-art')) return;
      const img = document.createElement('img');
      img.className = 'recent-played-art';
      img.alt = `${title} — ${artist} (cover art)`;
      img.loading = 'lazy';
      img.decoding = 'async';
      img.src = src;
      root.prepend(img);
    }

    // 1) If it’s already on the page (fast load), enhance immediately.
    const existing = document.querySelector('.recent-played');
    if (existing) tryEnhance(existing);

    // 2) Otherwise, observe DOM for when the widget arrives.
    const mo = new MutationObserver(muts => {
      for (const m of muts) {
        m.addedNodes && m.addedNodes.forEach(node => {
          if (node.nodeType === 1) {
            if (node.matches && node.matches('.recent-played')) tryEnhance(node);
            const found = node.querySelector && node.querySelector('.recent-played');
            if (found) tryEnhance(found);
          }
        });
      }
    });
    mo.observe(document.documentElement, {
      childList: true,
      subtree: true
    });
  })();
</script>
